# 补偿模型对比分析报告

## 1. 问题描述

| 模型 | 线性度结果 | 状态 |
|------|-----------|------|
| `compensation_model1.json` | 0.0035% | ✅ 正常 |
| `compensation_model2.json` | 0% | ⚠️ 异常 |

---

## 2. CSV 数据对比分析（已验证）

### 2.1 CSV 文件基本信息

| 参数 | model1.csv | model2.csv |
|------|------------|------------|
| **移动方向** | **正向** | **反向** |
| 数据点数 | 45 | 45 |
| 目标移动范围 | 1~45 mm | -1~-45 mm |

### 2.2 实际累计位移对比

| 参数 | model1.csv | model2.csv |
|------|------------|------------|
| **第一个值** | +0.9998 mm | **-0.9999 mm** |
| **最后一个值** | +44.9978 mm | **-44.9966 mm** |
| **符号** | **全正** ✅ | **全负** ⚠️ |
| **绝对值范围** | 0.9998 ~ 44.9978 | 0.9999 ~ 44.9966 |

### 2.3 CSV 数据示例

**model1.csv (正向移动):**
```csv
序号,移动方向,目标移动距离(mm),实际累计位移(mm),深度图文件名
1,正向,1.0000,0.9998,SecondaryCalib_0251218_100538_001.png
2,正向,2.0000,1.9997,SecondaryCalib_0251218_100538_002.png
...
45,正向,45.0000,44.9978,SecondaryCalib_0251218_100538_045.png
```

**model2.csv (反向移动):**
```csv
序号,移动方向,目标移动距离(mm),实际累计位移(mm),深度图文件名
1,反向,-1.0000,-0.9999,SecondaryCalib_0251218_155303_001.png
2,反向,-2.0000,-1.9996,SecondaryCalib_0251218_155303_002.png
...
45,反向,-45.0000,-44.9966,SecondaryCalib_0251218_155303_045.png
```

---

## 3. 根本原因确认

### 3.1 问题根源：移动方向不同

```
┌─────────────────────────────────────────────────────────────┐
│                      标定时的移动方向                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Model 1 (正向):  起点 ──────────────────────→ 终点         │
│                   0mm                         +45mm         │
│                   实际值: +0.9998 → +44.9978                │
│                                                             │
│  Model 2 (反向):  终点 ←────────────────────── 起点         │
│                  -45mm                         0mm          │
│                   实际值: -0.9999 → -44.9966                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**结论：两次标定使用了相反的移动方向，导致实际累计位移符号相反！**

### 3.2 模型参数验证

| 参数 | Model 1 | Model 2 | 来源验证 |
|------|---------|---------|----------|
| y_range | [0.9998, 41.9978] | [-44.9966, -2.9993] | ✅ 与CSV吻合 |
| 标定点数 | 42 | 43 | CSV有45个点，部分被过滤 |

### 3.3 线性度为0%的原因

```
测试数据使用 Model 1 的测试集（正向，实际值为正）

用 Model 2 补偿时：
┌────────────────────────────────────────────────────────────┐
│ 测试实际值:    [+1, +2, +3, ..., +42]  (正数)               │
│ Model 2 补偿:  [-45, -44, -43, ..., -3] (负数)              │
│                                                            │
│ 零点归一化后:                                               │
│ - 测试实际相对值:  [0, 1, 2, ..., 41]                       │
│ - 补偿后相对值:    [0, 1, 2, ..., 42]                       │
│                     ↑                                      │
│              相对变化量几乎完全相同！                         │
│                                                            │
│ 结果: 偏差 ≈ 0 → 线性度 = 0%                                │
└────────────────────────────────────────────────────────────┘
```

---

## 4. 模型参数对比

### 4.1 基本信息对比

| 参数 | Model 1 | Model 2 | 差异 |
|------|---------|---------|------|
| 标定点数 | 42 | 43 | +1 |
| 样条阶数 | 3 | 3 | 相同 |
| 版本 | 2.2 | 2.2 | 相同 |

### 4.2 关键范围对比

| 参数 | Model 1 | Model 2 | 差异 |
|------|---------|---------|------|
| **x_range（测量值）** | [-24.10, 17.55] | [-24.59, 17.89] | 相近 |
| **y_range（实际值）** | [**0.9998**, **41.9978**] | [**-44.9966**, **-2.9993**] | ⚠️ **符号相反** |

### 4.3 系数范围对比

| 参数 | Model 1 | Model 2 |
|------|---------|---------|
| 第一个系数 | 0.9998 | -44.9966 |
| 最后有效系数 | 41.9978 | -2.9993 |
| 系数符号 | **全正** | **全负** |
| 系数趋势 | 递增 (0→42) | 递增 (-45→-3) |

---

## 4. 可视化对比

### 4.1 补偿曲线示意

```
         Model 1                          Model 2
    实际值(mm)                       实际值(mm)
      ↑                                  ↑
   42 │        ●                     -3 │        ●
   35 │      ●                      -10 │      ●
   28 │    ●                        -20 │    ●
   21 │  ●                          -30 │  ●
   14 │●                            -40 │●
    7 │                             -45 │
      └────────→ 测量值                  └────────→ 测量值
        -24     18                        -24     18
```

### 4.2 补偿效果差异

```
输入测量值 = 0 mm 时:

Model 1 输出: ~21 mm (正常补偿)
Model 2 输出: ~-24 mm (负值补偿)

如果测试数据的期望值是正数（如 0-43mm），
而 Model 2 输出的是负数（-45 ~ -3mm），
计算线性度时会出现问题。
```

---

## 5. 线性度0%的具体原因

当使用 Model 2 对测试数据进行补偿时：

```python
# 假设测试数据的实际值是正数: [1, 2, 3, ..., 42] mm
actual_values = [1, 2, 3, ..., 42]

# Model 2 补偿后的值是负数: [-45, -44, -43, ..., -3] mm  
compensated_values = [-45, -44, -43, ..., -3]

# 零点归一化后:
actual_rel = [0, 1, 2, ..., 41]
compensated_rel = [0, 1, 2, ..., 42]  # 相对变化量是一样的！

# 由于相对变化量几乎完全一致，偏差 ≈ 0
# 因此线性度 = 0%
```

**关键发现：虽然绝对值不同，但两个模型的相对变化量（斜率）几乎相同！**

这说明：
- Model 2 的标定数据只是在 Model 1 的基础上做了偏移
- 由于线性度计算使用的是**相对值**，偏移量被消除了
- 导致线性度看起来是0%

---

## 6. 解决方案

### 6.1 CSV 数据已确认

✅ **已检查两个CSV文件，确认问题根源：**

| CSV文件 | 移动方向 | 实际累计位移 | 状态 |
|---------|---------|-------------|------|
| model1.csv | **正向** | +0.9998 ~ +44.9978 | ✅ 正常 |
| model2.csv | **反向** | -0.9999 ~ -44.9966 | ⚠️ 负值 |

### 6.2 解决方案

#### 方案A：修正CSV数据后重新标定（推荐）

将 model2.csv 的"实际累计位移"列转换为正值：

```python
# 转换公式
new_value = -old_value

# 示例
-0.9999 → +0.9999
-44.9966 → +44.9966
```

或者，使用绝对值：
```python
new_value = abs(old_value)
```

#### 方案B：直接转换现有模型

如果不想重新标定，可以修改 `compensation_model2.json`：

```python
import json

# 读取模型
with open('compensation_model2.json', 'r') as f:
    model = json.load(f)

# 转换系数（取反）
model['coefficients'] = [-c for c in model['coefficients']]

# 转换 y_range（取反）
model['y_range'] = [-model['y_range'][1], -model['y_range'][0]]

# 保存
with open('compensation_model2_fixed.json', 'w') as f:
    json.dump(model, f, indent=2)
```

转换后的值：
```
原 y_range: [-44.9966, -2.9993]
新 y_range: [2.9993, 44.9966]  ← 正值范围
```

#### 方案C：使用同向测试数据

如果 Model 2 用于补偿**反向移动**的测试数据（测试数据的实际值也是负数），则模型本身是正确的，只需确保测试时使用匹配的坐标系。

### 6.3 验证方法

使用相同的测试数据集，对两个模型进行补偿，比较：
1. 补偿后的**绝对值**
2. 补偿后的**相对变化量**

如果相对变化量一致，说明两个模型的**补偿精度相同**，只是坐标系不同。

---

## 7. 总结

| 问题 | 说明 |
|------|------|
| **根本原因** | Model 2 使用**反向移动**标定，CSV的"实际累计位移"为负值 |
| **线性度0%** | 测试数据为正值，模型输出为负值，但相对变化量相同，偏差≈0 |
| **模型有效性** | Model 2 的**相对补偿精度**与 Model 1 相同，只是坐标系不同 |
| **解决方法** | 修正CSV为正值后重新标定，或转换现有模型系数 |

### 关键发现

```
┌────────────────────────────────────────────────────────────┐
│  两次标定的本质差异：                                        │
│                                                            │
│  Model 1: 正向移动 (0 → +45mm)  →  实际值为正数              │
│  Model 2: 反向移动 (0 → -45mm)  →  实际值为负数              │
│                                                            │
│  两个模型的补偿精度是相同的，只是坐标系方向相反！              │
└────────────────────────────────────────────────────────────┘
```

### 建议操作

1. ✅ **已确认**：Model 2 的 CSV 使用了反向移动，实际值为负数
2. 📋 **下一步**：选择以下任一方案
   - 方案A：修正 CSV 后重新标定（最可靠）
   - 方案B：直接转换模型系数（快速）
   - 方案C：使用匹配坐标系的测试数据

---

*报告生成时间：2025年12月18日*
*更新时间：2025年12月18日（已验证CSV数据）*

