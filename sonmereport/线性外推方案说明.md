# 线性外推方案详细说明

## 1. 方案概述

当测量值超出补偿模型的有效范围时，使用**线性外推**来估算补偿后的值，而不是直接丢弃或保持原值。

```
         有效范围
    ←────────────────→
────┬────────────────────┬────
外推│    精确补偿区      │外推
区域│    (样条插值)      │区域
────┴────────────────────┴────
   低端                 高端
   边界                 边界
```

---

## 2. 线性外推原理

### 2.1 基本思想

在模型边界处，使用样条曲线的**切线斜率**进行线性延伸：

```
补偿值
  ↑
  │                    ╱ 高端外推线
  │                  ╱
  │               ●──┘ 高端边界点
  │            ●
  │         ●
  │      ●      (样条曲线)
  │   ●
  │●──┐ 低端边界点
  │    ╲
  │      ╲ 低端外推线
  └────────────────────────→ 测量值
```

### 2.2 数学公式

**低端外推**（测量值 < 模型最小值）：
```
y = y_min + slope_low × (x - x_min)

其中：
- y_min: 模型在最小边界处的输出值
- x_min: 模型的最小输入值
- slope_low: 模型在低端边界的斜率（切线斜率）
```

**高端外推**（测量值 > 模型最大值）：
```
y = y_max + slope_high × (x - x_max)

其中：
- y_max: 模型在最大边界处的输出值
- x_max: 模型的最大输入值
- slope_high: 模型在高端边界的斜率（切线斜率）
```

---

## 3. 可调参数

### 3.1 外推斜率计算方式

| 参数 | 选项 | 说明 |
|------|------|------|
| **斜率来源** | `derivative` | 使用样条曲线在边界点的导数（推荐） |
| | `two_points` | 使用边界附近两个点计算斜率 |
| | `fixed` | 使用固定斜率值（如 1.0） |

### 3.2 外推限制

| 参数 | 默认值 | 说明 |
|------|--------|------|
| **max_extrapolate_low** | 5.0 mm | 低端最大外推距离 |
| **max_extrapolate_high** | 5.0 mm | 高端最大外推距离 |
| **clamp_output** | True | 是否限制输出范围 |
| **output_min** | 0.0 mm | 输出最小值限制 |
| **output_max** | 43.0 mm | 输出最大值限制 |

### 3.3 超出外推范围的处理

| 参数 | 选项 | 说明 |
|------|------|------|
| **out_of_range_action** | `clamp` | 截断到边界值 |
| | `keep` | 保持原始测量值 |
| | `invalid` | 标记为无效（65535） |

---

## 4. 参数选择建议

### 4.1 针对您的场景

您的模型范围：
- x_range: [-24.0956, 17.5476]（测量值）
- y_range: [0.9998, 41.9978]（真实值）

设备范围：0 ~ 43 mm

**建议参数设置**：

```python
# 外推配置
EXTRAPOLATE_CONFIG = {
    # 斜率计算方式
    'slope_method': 'derivative',  # 使用样条导数（最准确）
    
    # 外推距离限制
    'max_extrapolate_low': 2.0,    # 低端最多外推2mm（覆盖到约-1mm）
    'max_extrapolate_high': 2.0,   # 高端最多外推2mm（覆盖到约44mm）
    
    # 输出范围限制
    'clamp_output': True,
    'output_min': 0.0,             # 输出不低于0mm
    'output_max': 43.0,            # 输出不超过43mm
    
    # 超出外推范围的处理
    'out_of_range_action': 'clamp'  # 截断到边界
}
```

### 4.2 不同场景的推荐配置

| 场景 | slope_method | max_extrapolate | clamp_output |
|------|-------------|-----------------|--------------|
| **精度优先** | derivative | 1.0 mm | True |
| **覆盖优先** | derivative | 5.0 mm | True |
| **保守策略** | fixed (1.0) | 2.0 mm | True |

---

## 5. 注意事项

### 5.1 外推精度会下降

⚠️ **重要**：外推区域的精度**低于**模型内部区域

```
精度
  ↑
高 │      ╭────────────────────╮
  │     ╱                      ╲
  │    ╱                        ╲
  │   ╱    模型有效范围内         ╲
低 │  ╱      精度最高              ╲
  │ ╱                              ╲
  └─────────────────────────────────→ 位置
    外推区  │←──有效范围──→│  外推区
```

### 5.2 外推距离与风险

| 外推距离 | 风险等级 | 精度估计 |
|----------|----------|----------|
| < 1 mm | 低 | 接近模型边界精度 |
| 1-2 mm | 中 | 可接受 |
| 2-5 mm | 高 | 明显下降 |
| > 5 mm | 很高 | 不推荐 |

### 5.3 监控外推使用情况

建议在使用时记录：
- 有多少像素落在外推区域
- 外推的平均距离
- 是否需要调整模型范围

---

## 6. 实现代码示例

```python
from scipy.interpolate import splev

def apply_compensation_with_extrapolation(measured_values, inverse_model, config):
    """
    带线性外推的补偿函数
    
    参数:
        measured_values: 测量值数组
        inverse_model: 逆向补偿模型 (t, c, k)
        config: 外推配置字典
    """
    t, c, k = inverse_model
    x_min, x_max = t[k], t[-k-1]  # 模型有效范围
    
    result = np.zeros_like(measured_values, dtype=np.float64)
    
    # 范围内的值：使用样条插值
    in_range = (measured_values >= x_min) & (measured_values <= x_max)
    result[in_range] = splev(measured_values[in_range], inverse_model)
    
    # 低端外推
    below_range = measured_values < x_min
    if np.any(below_range):
        # 计算低端斜率（样条导数）
        slope_low = splev(x_min, inverse_model, der=1)
        y_min = splev(x_min, inverse_model)
        
        # 线性外推
        result[below_range] = y_min + slope_low * (measured_values[below_range] - x_min)
    
    # 高端外推
    above_range = measured_values > x_max
    if np.any(above_range):
        # 计算高端斜率（样条导数）
        slope_high = splev(x_max, inverse_model, der=1)
        y_max = splev(x_max, inverse_model)
        
        # 线性外推
        result[above_range] = y_max + slope_high * (measured_values[above_range] - x_max)
    
    # 输出范围限制
    if config.get('clamp_output', True):
        result = np.clip(result, config['output_min'], config['output_max'])
    
    return result
```

---

## 7. 您的模型外推分析

基于您的补偿模型：

### 7.1 边界信息

| 边界 | 测量值(x) | 真实值(y) | 预估斜率 |
|------|-----------|-----------|----------|
| **低端** | -24.0956 mm | 0.9998 mm | ~1.0 |
| **高端** | 17.5476 mm | 41.9978 mm | ~1.0 |

### 7.2 外推覆盖估算

| 目标 | 需要外推 | 预估外推距离 |
|------|----------|--------------|
| 覆盖 0mm | y = 0mm | 约外推 1mm（y方向） |
| 覆盖 43mm | y = 43mm | 约外推 1mm（y方向） |

### 7.3 推荐配置

```python
# 针对您设备的推荐配置
EXTRAPOLATE_CONFIG = {
    'slope_method': 'derivative',
    'max_extrapolate_low': 2.0,   # 足够覆盖到0mm
    'max_extrapolate_high': 2.0,  # 足够覆盖到43mm
    'clamp_output': True,
    'output_min': 0.0,
    'output_max': 43.0,
    'out_of_range_action': 'clamp'
}
```

---

## 8. 总结

### 关键决策点

| 决策 | 推荐选择 | 原因 |
|------|----------|------|
| 斜率计算 | derivative | 最准确反映模型趋势 |
| 外推距离 | 2.0 mm | 足够覆盖缺失范围 |
| 输出限制 | 启用 | 防止异常输出 |
| 超范围处理 | clamp | 保守安全 |

### 实施步骤

1. ✅ 理解外推原理
2. ✅ 修改 `compensator.py` 添加外推功能
3. ✅ 在 UI 中添加外推参数配置
4. ⬜ 测试验证外推效果

---

## 9. 实现说明（已完成）

### 9.1 修改的文件

| 文件 | 修改内容 |
|------|----------|
| `config.py` | 添加外推配置参数 |
| `compensator.py` | 实现线性外推函数 |
| `ui/app.py` | 添加外推参数设置界面 |

### 9.2 新增配置参数

```python
# config.py 中的外推配置
EXTRAPOLATE_ENABLED = True        # 是否启用线性外推
EXTRAPOLATE_MAX_LOW = 2.0         # 低端最大外推距离 (mm)
EXTRAPOLATE_MAX_HIGH = 2.0        # 高端最大外推距离 (mm)
EXTRAPOLATE_OUTPUT_MIN = 0.0      # 输出最小值限制 (mm)
EXTRAPOLATE_OUTPUT_MAX = 43.0     # 输出最大值限制 (mm)
EXTRAPOLATE_CLAMP_OUTPUT = True   # 是否限制输出范围
```

### 9.3 新增函数

```python
# compensator.py 中的新函数
apply_compensation_with_extrapolation()  # 带线性外推的补偿
get_extrapolation_stats()                 # 获取外推统计信息
```

### 9.4 UI 新增设置

在"补偿模式"标签页中新增：
- ☑️ 启用线性外推 复选框
- 低端外推距离输入框
- 高端外推距离输入框
- 输出范围限制（最小值、最大值）

---

*报告生成时间：2025年12月18日*

