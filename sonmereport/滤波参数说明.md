# 深度图滤波参数说明

## 概述

在深度图补偿系统中，滤波处理是提高标定精度的重要步骤。系统提供了三种滤波方法，依次执行以消除噪声和异常值。

---

## 1. 异常值阈值（3σ准则）

### 配置参数

```python
OUTLIER_STD_FACTOR = 3.0  # 异常值去除的标准差倍数
```

### 含义

使用 **3σ准则**（三倍标准差法则）去除异常值（离群点）。

### 工作原理

```
1. 计算所有有效像素的均值(mean)和标准差(std)
2. 计算有效范围：[mean - 3×std, mean + 3×std]
3. 超出此范围的像素被标记为无效
```

### 示意图

```
              ←───────── 3σ ─────────→
         ─────┬───────────┬───────────┬─────
              │  99.7%    │   有效    │
         异常 │   正常    │   正常    │ 异常
              │   数据    │   数据    │
         ─────┴───────────┴───────────┴─────
            -3σ        mean         +3σ
```

### 统计学依据

根据正态分布的性质：
- **68.27%** 的数据落在 ±1σ 范围内
- **95.45%** 的数据落在 ±2σ 范围内
- **99.73%** 的数据落在 ±3σ 范围内

因此，超出 ±3σ 范围的数据只有 **0.27%** 的概率是正常值，大概率是异常值。

### 代码实现

```python
def filter_outliers(roi_region, std_factor=3.0):
    """异常值去除（3σ准则）"""
    mean_val = np.mean(valid_pixels)
    std_val = np.std(valid_pixels)
    
    lower = mean_val - std_factor * std_val  # 下限
    upper = mean_val + std_factor * std_val  # 上限
    
    # 超出范围的标记为无效
    outlier_mask = (filtered < lower) | (filtered > upper)
    filtered[outlier_mask] = INVALID_VALUE
```

### 作用

过滤掉明显偏离正常值的噪声点，如：
- 传感器故障产生的极端值
- 反射异常导致的错误测量
- 边缘效应产生的离群点

---

## 2. 中值滤波窗口（3×3）

### 配置参数

```python
MEDIAN_FILTER_SIZE = 3  # 中值滤波窗口大小
```

### 含义

使用 **3×3像素窗口** 进行中值滤波。

### 工作原理

对每个像素，取其周围 3×3 区域（9个像素）的**中值**作为新值。

### 示意图

```
原图像：                    中值滤波后：
┌───┬───┬───┐         
│ 2 │ 3 │ 5 │         
├───┼───┼───┤               中间像素
│ 4 │99 │ 6 │    →→→        99 → 5
├───┼───┼───┤               (取中值)
│ 3 │ 5 │ 7 │         
└───┴───┴───┘         

窗口内9个值排序: 2, 3, 3, 4, 5, 5, 6, 7, 99
中值（第5个）= 5
```

### 代码实现

```python
def apply_median_filter(roi_region, size=3):
    """中值滤波"""
    from scipy.ndimage import median_filter
    
    # 用有效像素的平均值填充无效区域
    valid_mean = temp[valid_mask].mean()
    temp[~valid_mask] = valid_mean
    
    # 应用中值滤波
    filtered = median_filter(temp, size=size)
```

### 作用

- **消除椒盐噪声**：随机出现的极亮或极暗像素
- **保持边缘锐度**：不会像均值滤波那样模糊边缘
- **抑制脉冲干扰**：单点异常值被邻域中值替代

### 窗口大小选择

| 窗口大小 | 效果 | 适用场景 |
|----------|------|----------|
| 3×3 | 轻度平滑 | 一般噪声 |
| 5×5 | 中度平滑 | 较强噪声 |
| 7×7 | 强力平滑 | 严重噪声（可能损失细节） |

---

## 3. 高斯滤波（σ=1.0）

### 配置参数

```python
GAUSSIAN_FILTER_SIGMA = 1.0  # 高斯滤波标准差
```

### 含义

使用标准差为 1.0 的高斯核进行平滑滤波。

### 工作原理

对每个像素，用其邻域像素的**加权平均**替代，权重按高斯分布：

```
高斯核（σ=1.0，近似）：
┌──────┬──────┬──────┐
│ 0.08 │ 0.12 │ 0.08 │
├──────┼──────┼──────┤
│ 0.12 │ 0.20 │ 0.12 │
├──────┼──────┼──────┤
│ 0.08 │ 0.12 │ 0.08 │
└──────┴──────┴──────┘
```

### 作用

- **平滑高频噪声**：减少图像中的随机噪声
- **保留低频信息**：不会破坏整体深度趋势
- **边缘适度模糊**：比均值滤波更自然

---

## 4. 滤波处理流程

三种滤波依次执行：

```
        原始深度图
            ↓
┌─────────────────────┐
│ 1. 异常值去除       │  ← 3σ阈值
│   (filter_outliers) │     去除极端离群点
└─────────────────────┘
            ↓
┌─────────────────────┐
│ 2. 中值滤波         │  ← 3×3窗口
│   (median_filter)   │     消除椒盐噪声
└─────────────────────┘
            ↓
┌─────────────────────┐
│ 3. 高斯滤波         │  ← σ=1.0
│   (gaussian_filter) │     平滑高频噪声
└─────────────────────┘
            ↓
       滤波后的深度图
```

---

## 5. 使用建议

### 推荐设置

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 异常值阈值 | 3.0σ | 平衡误判率和检测率 |
| 中值滤波窗口 | 3×3 | 轻度平滑，保留细节 |
| 高斯σ | 1.0 | 适度平滑 |

### 何时启用滤波

| 场景 | 建议 |
|------|------|
| 正常标定 | ✅ 启用（推荐） |
| 数据质量很高 | 可以禁用 |
| 噪声严重 | ✅ 必须启用 |
| 需要最大精度 | ✅ 启用可提升精度 |

### 注意事项

1. **滤波会略微改变数据**：但对于噪声数据，滤波后的结果更接近真实值
2. **窗口过大会损失细节**：保持默认的 3×3 窗口通常是最佳选择
3. **无效像素的处理**：系统用有效像素的均值填充无效区域，避免边界效应

---

## 6. 配置文件位置

所有参数定义在 `compcodeultimate/config.py`：

```python
# ========================
# 滤波配置
# ========================
FILTER_ENABLED = True           # 是否启用滤波
OUTLIER_STD_FACTOR = 3.0       # 异常值去除的标准差倍数
MEDIAN_FILTER_SIZE = 3         # 中值滤波窗口大小
GAUSSIAN_FILTER_SIGMA = 1.0    # 高斯滤波标准差
```

---

*文档生成时间：2025年12月18日*

